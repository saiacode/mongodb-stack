#MongoDB Stack
#Single Node
#Optional: CODE

version: '3.8'

networks:
  private:
  public:
    external: true
    name: ${PUBLIC_NET}
    
volumes:
  data:

secrets:
  mongo_initdb_root_username:
    external: true
    name: ${MONGO_INITDB_ROOT_USERNAME}
  mongo_initdb_root_password:
    external: true
    name: ${MONGO_INITDB_ROOT_PASSWORD}
  
services:
  mongo:
    image: ${MONGO_IMAGE}
    volumes:
      - data:/data/db
    ports:
      - "${STACK_CODE}17:27017"
    networks:
      - public
      - private
    secrets:
      - mongo_initdb_root_username
      - mongo_initdb_root_password
    environment:
      MONGO_INITDB_ROOT_USERNAME_FILE: /run/secrets/mongo_initdb_root_username
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/mongo_initdb_root_password
    deploy:
      resources:
        limits:
          cpus: ${MONGO_CPU_LIMIT}
          memory: ${MONGO_MEMORY_LIMIT}
        reservations:
          cpus: ${MONGO_CPU_RESERVATION}
          memory: ${MONGO_MEMORY_RESERVATION}
      placement:
        constraints:
          - node.labels.${NODE_LABEL} == 1 

  mongo-express:
    image: ${MONGO_EXPRESS_IMAGE}
    deploy:
      placement:
        constraints:
          - node.labels.${NODE_LABEL} == 1     
    ports:
      - ${STACK_CODE}81:8081
    networks:
      - private
    secrets:
      - mongo_initdb_root_username
      - mongo_initdb_root_password
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME_FILE: /run/secrets/mongo_initdb_root_username
      ME_CONFIG_MONGODB_ADMINPASSWORD_FILE: /run/secrets/mongo_initdb_root_password
      ME_CONFIG_MONGODB_AUTH_USERNAME_FILE: /run/secrets/mongo_initdb_root_username
      ME_CONFIG_MONGODB_AUTH_PASSWORD_FILE: /run/secrets/mongo_initdb_root_password

